parameters:
  - name: demands
    type: string
    default: "ucx_iodemo -equals yes"
  - name: initial_delay
    type: number
    default: 20
  - name: cycles
    type: number
    default: 100
  - name: downtime
    type: number
    default: 5
  - name: uptime
    type: number
    default: 180
  - name: tests
    type: object
    default:
      "tag match on CX4":
        args: ""
        duration: 600
        interface: $(roce_iface_cx4)
        tls: "rc_x"
        test_name: tag_cx4_rc
      "tag match on CX6":
        args: ""
        duration: 600
        interface: $(roce_iface_cx6)
        tls: "rc_x"
        test_name: tag_cx6_rc
      "tag match on CX6 with user memh":
        args: "-z"
        duration: 600
        interface: $(roce_iface_cx6)
        tls: "rc_x"
        test_name: tag_umemh_cx6_rc

jobs:
  - job: io_build
    displayName: Build io_demo

    pool:
      name: MLNX
      demands: ucx_docker -equals yes
    container: centos7

    steps:
      # address permissions issue when some files created as read-only
      - bash: chmod u+rwx ./ -R

      - checkout: self
        clean: true
        displayName: Checkout
      - bash: |
          set -eEx
          ./autogen.sh
          ./contrib/configure-devel --prefix=$(Build.Repository.LocalPath)/install
          make -j`nproc`
          make install
          # build static modules
          source ./buildlib/az-helpers.sh
          az_init_modules
          module load dev/libnl
          module load dev/numactl
          PKG_CONFIG_PATH=$(Build.Repository.LocalPath)/install/lib/pkgconfig:$PKG_CONFIG_PATH make -C test/apps/uct_info EXTRA_MODULES="ucx-ib ucx-cma ucx-rdmacm"
          module unload dev/numactl
          module unload dev/libnl
        displayName: Build
        name: build
      - task: CopyFiles@2
        inputs:
          sourceFolder: '$(Build.Repository.LocalPath)'
          contents: |
            buildlib/az-helpers.sh
            buildlib/az-network-corrupter.sh
            buildlib/check_tls.sh
            install/**
            test/apps/iodemo/run_io_demo.sh
            test/apps/uct_info/*
          targetFolder: '$(Build.ArtifactStagingDirectory)'
      - task: PublishBuildArtifacts@1
        inputs:
          pathToPublish: '$(Build.ArtifactStagingDirectory)'
          artifactName: drop_$(Build.BuildId)

  - job: test
    dependsOn: io_build
    workspace:
      clean: all

    pool:
      name: MLNX
      demands: ${{ parameters.demands }}

    strategy:
      matrix:
        ${{ each test in parameters.tests }}:
          ${{ test.Key }}:
            test_name: ${{ test.Value.test_name }}
            test_args: ${{ test.Value.args }}
            test_time: ${{ test.Value.duration }}
            test_intefrafe: ${{ test.Value.interface }}
            test_ucx_tls: ${{ test.Value.tls }}
            initial_delay: ${{ coalesce(test.Value.initial_delay, parameters.initial_delay) }}
      maxParallel: 1

    variables:
      workspace: drop_$(Build.BuildId)
      io_demo_exe: drop_$(Build.BuildId)/install/bin/io_demo
      cycles: ${{ parameters.cycles }}
      downtime: ${{ parameters.downtime }}
      uptime: ${{ parameters.uptime }}

    displayName: "Test "
    steps:
      - checkout: none
        clean: true
      - task: DownloadBuildArtifacts@0
        displayName: 'Download Build Artifacts'
        inputs:
          artifactName: drop_$(Build.BuildId)
          downloadPath: $(System.DefaultWorkingDirectory)
      - bash: chmod u+rwx $(workspace) -R
      - template: az-stage-io-demo.yaml
        parameters:
          name: $(test_name)
          iodemo_args: $(test_args)
          duration: $(test_time)
          roce_iface: $(test_intefrafe)
          iodemo_tls: $(test_ucx_tls)
          initial_delay: $(initial_delay)
          ${{ if eq(variables['Build.Reason'], 'PullRequest') }}:
            analyzer_allow_list_args: '--allow_list $(System.PullRequest.TargetBranch)'

  - job: test_static
    dependsOn: io_build
    workspace:
      clean: all

    pool:
      name: MLNX
      demands: ${{ parameters.demands }}

    variables:
      workspace: drop_$(Build.BuildId)
      EXECUTOR_NUMBER: $(Build.BuildId)

    displayName: "Test static"
    steps:
      - checkout: none
        clean: true
      - task: DownloadBuildArtifacts@0
        displayName: 'Download Build Artifacts'
        inputs:
          artifactName: drop_$(Build.BuildId)
          downloadPath: $(System.DefaultWorkingDirectory)
      - bash: chmod u+rwx $(workspace) -R
      - bash: |
          set -eEx
          cd $(workspace)/test/apps/uct_info
          LD_LIBRARY_PATH=$(System.DefaultWorkingDirectory)/$(workspace)/install/lib:$LD_LIBRARY_PATH \
                  $(System.DefaultWorkingDirectory)/$(workspace)/buildlib/check_tls.sh \
                  dc_mlx5 rc_mlx5 ud_mlx5 rc_verbs ud_verbs cma
          # Set port number for hello_world applications
          server_port=$((10000 + (EXECUTOR_NUMBER % 1000)))
          server_port_arg="-p $server_port"

          for tls in ib rc rc_x; do
            echo UCX_TLS=$tls
            UCX_TLS=$tls ./ucp_hello_world_static ${server_port_arg} &
            # allow server to start
            sleep 3
            UCX_TLS=$tls ./ucp_hello_world_static ${server_port_arg} -n localhost
            # allow server to complete
            sleep 3
          done

          cd -
